# Generated by Django 5.2.6 on 2025-09-23 17:46

from django.db import migrations, models


def convert_text_to_json(apps, schema_editor):
    Post = apps.get_model("posts", "Post")
    db_alias = schema_editor.connection.alias

    queryset = Post.objects.using(db_alias).all()

    for post in queryset.iterator():
        value = post.text

        if value in (None, ""):
            continue

        if isinstance(value, str):
            try:
                json.loads(value)
            except json.JSONDecodeError:
                queryset.filter(pk=post.pk).update(text=json.dumps(value))
        else:
            queryset.filter(pk=post.pk).update(text=json.dumps(value))


class Migration(migrations.Migration):

    dependencies = [
        ('posts', '0003_alter_post_author'),
    ]

    operations = [
        migrations.AlterField(
            model_name='post',
            name='image',
            field=models.ImageField(blank=True, null=True, upload_to='posts/images/'),
        ),
        migrations.AlterField(
            model_name='post',
            name='text',
            field=models.JSONField(),
        ),
    ]
